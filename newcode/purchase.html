<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è³¼å…¥ç¢ºèªãƒšãƒ¼ã‚¸</title>
  <link rel="stylesheet" href="purchase.css" />
</head>
<body>
  <h1>ğŸ§¾ è³¼å…¥å†…å®¹ã®ç¢ºèª</h1>

  <button onclick="history.back()" style="
    margin: 20px;
    padding: 10px 16px;
    background-color: #f0f0f0;
    border: 1px solid #ccc;
    border-radius: 6px;
    cursor: pointer;
  ">â† ã‚«ãƒ¼ãƒˆã«æˆ»ã‚‹</button>

  <div id="cart-items" class="cart-box"></div>
  <p id="cart-total" class="total-text"></p>

  <button class="purchase-btn" onclick="completePurchase()">âœ… ã“ã®å†…å®¹ã§è³¼å…¥ã™ã‚‹</button>

 <script>
ã€€let group = sessionStorage.getItem("group") || "A"; 
ã€€console.log("Experiment group (this page):", group);
  
//åˆå›ã‚¢ã‚¯ã‚»ã‚¹è¨˜éŒ²
    if (!localStorage.getItem("entryTime")) {
      localStorage.setItem("entryTime", new Date().toISOString());
    }

    const cart = JSON.parse(localStorage.getItem("cart") || "[]");
    const cartItemsDiv = document.getElementById("cart-items");
    const cartTotalP = document.getElementById("cart-total");

    let total = 0;

//ã‚«ãƒ¼ãƒˆå†…è¡¨ç¤º
    cart.forEach(item => {
      const div = document.createElement("div");
      div.className = "cart-item";
      div.innerHTML = `
        <div class="item-info">
          <strong>${item.name}</strong> Ã— ${item.quantity}
          <span>ï¼ˆÂ¥${item.price * item.quantity}ï¼‰</span>
        </div>
      `;
      cartItemsDiv.appendChild(div);
      total += item.price * item.quantity;
    });

    cartTotalP.textContent = `åˆè¨ˆé‡‘é¡: Â¥${total.toLocaleString()}`;

    let isSending = false;

    function completePurchase() {
      if (isSending) return;
      isSending = true;

      const btn = document.querySelector('.purchase-btn');
      btn.disabled = true;
      btn.textContent = "å‡¦ç†ä¸­â€¦";

      const userName = localStorage.getItem("userName");

      if (!userName || userName.trim() === "") {
        alert("åå‰ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚Šã¾ã™ã€‚");
        btn.disabled = false;
        btn.textContent = "âœ… ã“ã®å†…å®¹ã§è³¼å…¥ã™ã‚‹";
        isSending = false;
        location.href = "index.html";
        return;
      }

      const entryTime = new Date(localStorage.getItem("entryTime"));
      const leaveTime = new Date();
      const stayMinutes = Math.round((leaveTime - entryTime) / 1000 / 60);

      const itemsSummary = cart.map(item => `${item.name}x${item.quantity}`).join(", ");
      const pathHistory = JSON.parse(localStorage.getItem("pageHistory") || "[]");
      const pathText = pathHistory.join(" â†’ ");

      const gasUrl = "https://script.google.com/macros/s/AKfycbzFMy8XoOnNS-jgl_OWVsk-VlL1F9safbBj4BQAlCZZ0VNPMhzRD12-4DYByQj7SmXu1Q/exec"
      
      const params = new URLSearchParams({
        action: "purchase",
        stay: stayMinutes,
        total: total,
        items: itemsSummary,
        name: userName,
        group: group,
        history: pathText
      });

      fetch(`${gasUrl}?${params.toString()}`)
        .then(response => response.text())
        .then(data => {
          console.log("ã‚µãƒ¼ãƒãƒ¼å¿œç­”:", data);
          alert("è³¼å…¥ãŒè¨˜éŒ²ã•ã‚Œã¾ã—ãŸï¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚");
          localStorage.clear();
          location.href = "index.html";
        })
        .catch(error => {
          alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ");
          console.error("ã‚¨ãƒ©ãƒ¼:", error);
          btn.disabled = false;
          btn.textContent = "âœ… ã“ã®å†…å®¹ã§è³¼å…¥ã™ã‚‹";
          isSending = false;
        });
    }
  </script>

  <script src="track.js"></script>

<script>
  window.onload = function() {
    const currentPage = window.location.pathname.split("/").pop() || "home";
    let pageHistory = JSON.parse(localStorage.getItem("pageHistory") || "[]");
    pageHistory.push(currentPage);
    if (pageHistory.length > 100) {
      pageHistory.shift();
    }
    localStorage.setItem("pageHistory", JSON.stringify(pageHistory));

    const apiURL = "https://script.google.com/macros/s/AKfycbzFMy8XoOnNS-jgl_OWVsk-VlL1F9safbBj4BQAlCZZ0VNPMhzRD12-4DYByQj7SmXu1Q/exec";
    const params = new URLSearchParams({
      action: "visit",
      history: pageHistory.join(" â†’ "),
      page: currentPage
    });

    fetch(`${apiURL}?${params.toString()}`)
      .then(response => response.text())
      .then(data => console.log("è¨ªå•è¨˜éŒ²æˆåŠŸ:", data))
      .catch(err => console.error("è¨ªå•è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:", err));
  };
</script>


</body>
</html>
