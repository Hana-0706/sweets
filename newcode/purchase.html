<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è³¼å…¥ç¢ºèªãƒšãƒ¼ã‚¸</title>
  <link rel="stylesheet" href="purchase.css" />
</head>
<body>
  <h1>ğŸ§¾ è³¼å…¥å†…å®¹ã®ç¢ºèª</h1>

  <button onclick="history.back()" style="
    margin: 20px;
    padding: 10px 16px;
    background-color: #f0f0f0;
    border: 1px solid #ccc;
    border-radius: 6px;
    cursor: pointer;
  ">â† ã‚«ãƒ¼ãƒˆã«æˆ»ã‚‹</button>

  <div id="cart-items" class="cart-box"></div>
  <p id="cart-total" class="total-text"></p>

  <button class="purchase-btn" onclick="completePurchase()">âœ… ã“ã®å†…å®¹ã§è³¼å…¥ã™ã‚‹</button>

  <script>
//åˆå›ã‚¢ã‚¯ã‚»ã‚¹è¨˜éŒ²
    if (!localStorage.getItem("entryTime")) {
      localStorage.setItem("entryTime", new Date().toISOString());
    }

    const cart = JSON.parse(localStorage.getItem("cart") || "[]");
    const cartItemsDiv = document.getElementById("cart-items");
    const cartTotalP = document.getElementById("cart-total");

    let total = 0;

//ã‚«ãƒ¼ãƒˆå†…å®¹ã‚’è¡¨ç¤º
    cart.forEach(item => {
      const div = document.createElement("div");
      div.className = "cart-item";
      div.innerHTML = `
        <div class="item-info">
          <strong>${item.name}</strong> Ã— ${item.quantity}
          <span>ï¼ˆÂ¥${item.price * item.quantity}ï¼‰</span>
        </div>
      `;
      cartItemsDiv.appendChild(div);
      total += item.price * item.quantity;
    });

    cartTotalP.textContent = `åˆè¨ˆé‡‘é¡: Â¥${total.toLocaleString()}`;

    let isSending = false;

    function completePurchase() {
      if (isSending) return;
      isSending = true;

      const btn = document.querySelector('.purchase-btn');
      btn.disabled = true;

      const userName = localStorage.getItem("userName");

      if (!userName || userName.trim() === "") {
        alert("åå‰ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚Šã¾ã™ã€‚");
        location.href = "index.html";
        return;
      }

      const entryTime = new Date(localStorage.getItem("entryTime"));
      const leaveTime = new Date();
      const stayMinutes = Math.round((leaveTime - entryTime) / 1000 / 60);

      const itemsSummary = cart.map(item => `${item.name}x${item.quantity}`).join(", ");
      const pathHistory = JSON.parse(localStorage.getItem("pageHistory") || "[]");
      const pathText = pathHistory.join(" â†’ ");

      const gasUrl = "https://script.google.com/macros/s/AKfycbxce3VnUPC9bMazNu-OfnKGbMZnprXs7MvSmIhDiNQOZle5qeFxyQtHY_y0hFD0yEzRyw/exec";

      const params = new URLSearchParams({
        action: "purchase",
        stay: stayMinutes,
        total: total,
        items: itemsSummary,
        name: userName,
        history: pathText
      });

      fetch(`${gasUrl}?${params.toString()}`)
        .then(response => {
          alert("è³¼å…¥ãŒè¨˜éŒ²ã•ã‚Œã¾ã—ãŸï¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚");
          localStorage.clear();
          location.href = "thanks.html";
        })
        .catch(error => {
          alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ");
          console.error(error);
          btn.disabled = false;
          isSending = false;
        });
    }
  </script>

  <script src="track.js"></script>
</body>
</html>
